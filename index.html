<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Khủng Long</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        canvas {
            background: white;
            border: 2px solid black;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        #score {
            font-size: 22px;
            margin: 5px;
        }
        #countdown {
            font-size: 48px;
            color: blue;
            margin: 10px;
            display: none;
        }
        #gameOver {
            font-size: 24px;
            color: red;
            margin: 10px;
            display: none;
        }
    </style>
</head>
<body>

<h2>Game Khủng Long Cổ Điển</h2>
<button id="startButton">Bắt đầu</button>
<div id="countdown"></div>
<div id="score">Điểm: 0</div>
<div id="gameOver">Game Over! Nhấn Space để chơi lại</div>

<canvas id="gameCanvas" width="800" height="200"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const startButton = document.getElementById("startButton");
const scoreDiv = document.getElementById("score");
const countdownDiv = document.getElementById("countdown");
const gameOverDiv = document.getElementById("gameOver");

// ===== DINO =====
let dino = {
    x: 50,
    y: 150,
    width: 40,
    height: 40,
    dy: 0,
    jumping: false,
    ducked: false
};

// ===== GAME VARS =====
let obstacles = [];
let score = 0;
let gameRunning = false;
let gameOver = false;

// Nhảy & rơi nhanh
let gravity = 0.8;
let jumpStrength = -14;

let obstacleSpeed = 5;
let maxSpeed = 11;
let speedCounter = 0;

// Delay cactus 3s
let cactusDelayCounter = 0;
const CACTUS_DELAY = 180;

// ===== KHOẢNG CÁCH AN TOÀN =====
const SAFE_MIN_DISTANCE = 220;
const SAFE_MAX_DISTANCE = 400;

// ===== RANDOM DISTANCE =====
function randomSafeDistance() {
    return SAFE_MIN_DISTANCE +
        Math.random() * (SAFE_MAX_DISTANCE - SAFE_MIN_DISTANCE);
}

let nextCactusDistance = randomSafeDistance();

// ===== DRAW =====
function drawDino() {
    ctx.fillStyle = "green";
    let h = dino.ducked ? 20 : dino.height;
    let y = dino.ducked ? dino.y + 20 : dino.y;
    ctx.fillRect(dino.x, y, dino.width, h);
}

function drawObstacles() {
    ctx.fillStyle = "red";
    obstacles.forEach(o => {
        ctx.fillRect(o.x, o.y, o.width, o.height);
    });
}

function drawGround() {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 190, canvas.width, 10);
}

// ===== UPDATE =====
function updateDino() {
    if (dino.jumping) {
        dino.dy += gravity;
        dino.y += dino.dy;

        if (dino.y >= 150) {
            dino.y = 150;
            dino.dy = 0;
            dino.jumping = false;
        }
    }
}

function spawnCactus() {
    obstacles.push({
        x: canvas.width,
        y: 150,
        width: 20,
        height: 40
    });

    // ❗ CHỈ TRƯỜNG HỢP NÀY mới spawn 2 cây sát nhau
    if (Math.random() < 0.25) {
        obstacles.push({
            x: canvas.width + 35,
            y: 150,
            width: 20,
            height: 40
        });
    }

    nextCactusDistance = randomSafeDistance();
}

function updateObstacles() {
    cactusDelayCounter++;

    obstacles.forEach(o => o.x -= obstacleSpeed);
    obstacles = obstacles.filter(o => o.x > -o.width);

    if (cactusDelayCounter < CACTUS_DELAY) return;

    if (obstacles.length === 0) {
        spawnCactus();
    } else {
        let last = obstacles[obstacles.length - 1];
        if (canvas.width - last.x >= nextCactusDistance) {
            spawnCactus();
        }
    }
}

function checkCollision() {
    obstacles.forEach(o => {
        let h = dino.ducked ? 20 : dino.height;
        let y = dino.ducked ? dino.y + 20 : dino.y;

        if (
            dino.x < o.x + o.width &&
            dino.x + dino.width > o.x &&
            y < o.y + o.height &&
            y + h > o.y
        ) {
            gameOver = true;
            gameRunning = false;
            gameOverDiv.style.display = "block";
        }
    });
}

// ===== GAME LOOP =====
function gameLoop() {
    if (!gameRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawGround();
    drawDino();
    drawObstacles();

    updateDino();
    updateObstacles();
    checkCollision();

    score++;
    scoreDiv.textContent = "Điểm: " + Math.floor(score / 10);

    speedCounter++;
    if (speedCounter >= 60 && obstacleSpeed < maxSpeed) {
        obstacleSpeed += 0.12;
        speedCounter = 0;
    }

    requestAnimationFrame(gameLoop);
}

// ===== COUNTDOWN =====
function startCountdown() {
    let count = 3;
    countdownDiv.style.display = "block";
    countdownDiv.textContent = count;

    const timer = setInterval(() => {
        count--;
        if (count > 0) {
            countdownDiv.textContent = count;
        } else {
            clearInterval(timer);
            countdownDiv.style.display = "none";
            gameRunning = true;
            gameLoop();
        }
    }, 1000);
}

// ===== RESET =====
function resetGame() {
    obstacles = [];
    score = 0;
    obstacleSpeed = 5;
    speedCounter = 0;
    cactusDelayCounter = 0;
    nextCactusDistance = randomSafeDistance();

    dino.y = 150;
    dino.dy = 0;
    dino.jumping = false;
    dino.ducked = false;

    gameOver = false;
    gameOverDiv.style.display = "none";

    startCountdown();
}

// ===== EVENTS =====
startButton.addEventListener("click", () => {
    startButton.style.display = "none";
    resetGame();
});

document.addEventListener("keydown", e => {
    if (e.code === "Space") {
        e.preventDefault();
        if (gameRunning && !dino.jumping && !dino.ducked) {
            dino.jumping = true;
            dino.dy = jumpStrength;
        } else if (gameOver) {
            resetGame();
        }
    }

    if (e.code === "ArrowDown" && gameRunning && !dino.jumping) {
        dino.ducked = true;
    }
});

document.addEventListener("keyup", e => {
    if (e.code === "ArrowDown") {
        dino.ducked = false;
    }
});
</script>

</body>
</html>
